{"pageProps":{"id":1617753600,"fileName":"selenium-grid-4","url":"2021/04/07/selenium-grid-4","title":"Selenium Grid 4 體驗","description":"最近在處理系統交接並且升級相關的系統發現了Selenium Grid出了第四版現正Beta時讓我躍躍欲試， 以前Selenium Grid 3.x版本的時候UI說真的不怎麼樣，做了Selenium Grid 4的時候樣式跟整個畫面的設計全改了。 整個畫面看起來舒服了不少，但相關的東西也改了不少讓我一開始做測試的時候跌了不少次","date":"2021-04-07T00:00:00.000Z","tags":{"postgresql":1,"database":2,".net":1,"aws":4,"devops":7,"prevision":6,"iot":2,"platformio":2,"arduino":2,"esp":1,"elk":3,"azure":4,"vulnerability":1,"ssl":2,"vmss":1,"cd":3,"study4":1,"dotnetconf":1,"selenium":2,"tdd":1,"react":3,"jest":1,"next.js":1,"frontend":1,"layout":1,"ec2":1,"iac":1,"terraform":1,"ci":1,"jenkins":1,"ecs":1,"ansible":1,"redis":2,"protobuf":2,"serialize":2,"deserialize":2,"pub":1,"sub":1,"notify":1},"published":true,"content":"\n最近在處理系統交接並且升級相關的系統發現了Selenium Grid出了第四版現正Beta時讓我躍躍欲試，\n以前Selenium Grid 3.x版本的時候UI說真的不怎麼樣，做了Selenium Grid 4的時候樣式跟整個畫面的設計全改了。\n整個畫面看起來舒服了不少，但相關的東西也改了不少讓我一開始做測試的時候跌了不少次\n\n![selenium 4](selenium-grid-4/selenium-4.png)\n\n## Selenium 架構變更\n\n在[Selenium Component](https://www.selenium.dev/documentation/en/grid/grid_4/components_of_a_grid/)文件中就給了一張架構圖，\n跟過去只有HUB跟Node的架構有所差距，在整個部署與調整上擁有了更多彈性。你可以將HUB分散在多台的Server做部署，\n或是你可以使用經典模式的HUB將這些分散的服務集中在HUB中。\n\n新增的component有以下幾個，或者是你可以使用Hub來取代這些新的component\n- Router\n- Distributor\n- Session Map\n- New Session Queuer\n- Event Bus\n\n## Selenium Node Session的改變\n\n在以前Selenium 3.x的時候，我們可以去使用MAX_SESSIONS指定該instance的Session數量，所以在自動化測試的機器叢集中我都直接給10個讓每一個node都具有10個session，\n但這一次改版後即便你加了`SE_NODE_MAX_SESSIONS`的數量，但你的CPU數量不足時也無法產生更多的Session，新版本Node的Session數量取決於你設定的最大Session與CPU最小的那一個\n在官方的github中[這一段說明](https://github.com/SeleniumHQ/docker-selenium#increasing-session-concurrency-per-container)沒仔細看還真的很容易就給他忽略過去\n\n## Dynamic Grid的使用\n\n在新版本的Selenium Grid支援了Dynamic Grid，可以在每一次測試的時候才產生相對應的目標瀏覽器，而不用預先建置好這些瀏覽器的session\n\n在公司的Selenium的測試從集中，都採用docker的方式啟動這個對我來說可以減少在infrastructure的設定與管理\n\n以下分享我的設定，在config.toml的部分讓docker-node可以使用host的docker花了一下功夫\n\n```coffeescript\n# config.toml\n\n[docker]\n# Configs have a mapping between the Docker image to use and the capabilities that need to be matched to\n# start a container with the given image.\nconfigs = [\n    \"selenium/standalone-firefox:4.0.0-beta-3-prerelease-20210402\", \"{\\\"browserName\\\": \\\"firefox\\\"}\",\n    \"selenium/standalone-chrome:4.0.0-beta-3-prerelease-20210402\", \"{\\\"browserName\\\": \\\"chrome\\\"}\",\n    \"selenium/standalone-opera:4.0.0-beta-3-prerelease-20210402\", \"{\\\"browserName\\\": \\\"operablink\\\"}\",\n    \"selenium/standalone-edge:4.0.0-beta-3-prerelease-20210402\", \"{\\\"browserName\\\": \\\"msedge\\\"}\"\n    ]\n\n# URL for connecting to the docker daemon\n# host.docker.internal works for macOS and Windows.\n# Linux could use --net=host in the `docker run` instruction or 172.17.0.1 in the URI below.\n# To have Docker listening through tcp on macOS, install socat and run the following command\n# socat -4 TCP-LISTEN:2375,fork UNIX-CONNECT:/var/run/docker.sock\nurl = \"unix:///var/run/docker.sock\"\n# Docker imagee used for video recording\nvideo-image = \"selenium/video:ffmpeg-4.3.1-20210402\"\n\n# Uncomment the following section if you are running the node on a separate VM\n# Fill out the placeholders with appropriate values\n#[server]\n#host = <ip-from-node-machine>\n#port = <port-from-node-machine>\n\n[selenium official github](https://github.com/SeleniumHQ/docker-selenium#dynamic-grid-)\n```\n\n```yml\nversion: \"3\"\nservices:\n  node-docker:\n    image: selenium/node-docker:4.0.0-beta-3-prerelease-20210402\n    user: root\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n      - ./config.toml:/opt/bin/config.toml\n    depends_on:\n      - hub\n    environment:\n      - SE_EVENT_BUS_HOST=hub\n      - SE_EVENT_BUS_PUBLISH_PORT=4442\n      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443\n      - SE_NODE_OVERRIDE_MAX_SESSIONS=true\n      - SE_NODE_MAX_SESSIONS=10\n  hub:\n    image: selenium/hub:4.0.0-beta-3-prerelease-20210402\n    user: root\n    ports:\n      - \"4442:4442\"\n      - \"4443:4443\"\n      - \"4444:4444\"\n    logging:\n      options:\n        max-size: 100m\n        max-file: \"1\"\n    restart: always\n```\n\n## 參考連結\n\n[Selenium document](https://www.selenium.dev/documentation/en/grid/grid_4/components_of_a_grid/)\n\n[Max sessions](https://github.com/SeleniumHQ/docker-selenium#increasing-session-concurrency-per-container)\n"},"__N_SSG":true}