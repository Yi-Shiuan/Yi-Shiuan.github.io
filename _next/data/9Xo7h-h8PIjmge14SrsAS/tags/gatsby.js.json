{"pageProps":{"posts":[{"id":1666224000,"fileName":"gatsbyjs-to-nextjs","url":"2022/10/20/gatsbyjs-to-nextjs","title":"從Gatsby.js轉換到Next.js","description":"紀錄從Gatsby.js轉換到了Next.js的踩地雷過程","date":"2022-10-20T00:00:00.000Z","tags":["react","gatsby.js","next.js"],"published":true,"content":"\n其實Gatsby.js並沒有什麼不好，只是他每一次改版都需要花費許多精力去做更新，我從1.0用到了3.0，最後4.0真的讓我痛下決心轉換到了Next.js的懷抱\n\n雖然官方有介紹如何從Gatsby.js遷移到Next.js的範例，但說真的還有許多沒有寫清楚的地方這邊先做幾個紀錄\n\n## 更新package.json\n\n除離移除所有的Gatsby.js的套件外，還需要安裝幾個套件這幾個套件官方都有說明主要是為了渲染markdown的文件以及讀取markdown的文件的套件功能\n\n```json\n{\n  \"scripts\": {\n    \"build\": \"next build\",\n    \"export\": \"next export\",\n    \"dev\": \"next dev\",\n    \"start\": \"next start\"\n  },\n  \"subpath\": \"`/*\",\n  \"dependencies\": {\n    \"gray-matter\": \"^4.0.3\",\n    \"next\": \"^12.3.1\",\n    \"react-markdown\": \"^8.0.3\",\n    \"react-syntax-highlighter\": \"^15.4.4\",\n    \"remark\": \"^14.0.2\",\n    \"remark-html\": \"^15.0.1\"\n  }\n}\n```\n\n## 讀取markdown檔案\n\n在部落格中的markdown文件資料夾是這樣放的 `src/posts/{post}.mdx`\n\n```typescript\n// posts.ts\n\nimport dayjs from 'dayjs';\nimport fs from 'fs';\nimport matter from 'gray-matter';\nimport { join } from 'path';\n\nexport type Post = {\n    id: number;\n    fileName: string;\n    url: string;\n    title: string;\n    tags: string[];\n    content: string;\n    date: Date;\n    publish: boolean;\n    description: string;\n}\n\nconst postsDirectory = join(process.cwd(), '<<markdown 檔案位置>>');\nlet posts: Post[] = [];\n\n// 取得markdown文件中的內容\nexport const getPost: Function = (slug: string): Post => {\n    const realSlug = slug.replace(/\\.mdx$/, '');\n    const fullPath = join(postsDirectory, `${ slug }`);\n    const fileContents = fs.readFileSync(fullPath, 'utf8');\n    const {\n        data,\n        content,\n    } = matter(fileContents);\n\n    const obj = JSON.parse(JSON.stringify(data));\n    return {\n        id: dayjs(data.date).unix(),\n        fileName: realSlug,\n        url: `${ dayjs(data.date).format('YYYY/MM/DD') }/${ realSlug }`,\n        ...obj,\n        content,\n    } as Post;\n};\n\n// 列表目標資料夾中的所有markdown檔案，並且逐一取得markdown文件中的資料\nexport const getAllPosts: Function = (): Post[] => {\n    if ( posts.length === 0 ) {\n        const slugs = fs.readdirSync(postsDirectory);\n        posts = slugs.map((slug) => {\n            return getPost(slug);\n        });\n    }\n\n    return posts;\n};\n```\n\n## 文章列表\n\n有了這些，就可以把文章列表的部分印出來了！\n\n```typescript jsx\nexport const getStaticProps: GetStaticProps = async (context: GetStaticPropsContext<ParsedUrlQuery>): Promise<any> => {\n    const posts: Post[] = getAllPosts();\n    return {\n        props: {\n            posts: posts.slice(0, 10)\n        },\n    };\n};\n```\n\n## 文章內文\n\n接下來要讀取markdown中的內容，並且渲染出整個html，然後我也有針對markdwon的element做客制處理，例如`h1`的渲染就會如同下方的html\n\n```typescript jsx\nexport const h1 = (props: any) => {\n    const {children} = props;\n\n    return <div className={classNames(\"u-heading-v3\", \"g-mb-40\")}>\n        <h1 className={classNames(\"h1\", \"u-heading-v3__title\")}>\n            {children}\n        </h1>\n    </div>\n}\n```\n\n另外官方給的方式，渲染移植會有錯誤（如下圖），所以自己做了一個呈現的頁面，讓畫面可以有更完整的客製化功能\n\n![渲染錯誤](gatsbyjs-to-nextjs/render-error.png)\n\n```typescript jsx\nimport { NextPage } from 'next';\nimport ReactMarkdown from 'react-markdown';\n\nconst Posts: NextPage = (props: any) => {\n    return <>\n        <div className={ classNames('g-mb-30') }>\n             {/*略*/}\n            <ReactMarkdown components={ connponents }>{ props.content }</ReactMarkdown>\n        </div>\n        {/*略*/}\n    </>;\n};\n\nexport const getStaticProps: GetStaticProps = async ({ params }: any): Promise<any>  => {\n    const post = getPost(`${params.post[3]}.mdx`);\n    return {\n        props: {\n            ...post\n        },\n    };\n};\n\nexport const getStaticPaths: GetStaticPaths = async (): Promise<any>  => {\n    const posts = getAllPosts();\n    return {\n        paths: posts.map((post: Post) => {\n            return {\n                params: {\n                    post: post.url.split('/').map(i => i.toString()),\n                },\n            };\n        }),\n        fallback: false,\n    };\n};\n```\n\n## Tag標籤\n\n在Gatsby.js可以透過gql把文章標籤弄出來但在next.js中就只能自己處理了..\n\n我先在posts.ts中新加一個method，可以處理把文章的tag都列出來，然後在每一頁中添加印出tag的處理，這樣子就把原本Gatsby原有的功能做出來了！接下來差了分頁功能...\n\n```typescript\n// posts.ts\nexport const getTags: Function = (): { [index: string]: number } => {\n    const tags: { [index: string]: number } = {};\n    posts.forEach((post: Post) => {\n        post.tags.forEach((tag: string) => {\n            if ( tags[tag] === undefined ) {\n                tags[tag] = 1;\n            } else {\n                tags[tag]++;\n            }\n        });\n    });\n\n    return tags;\n};\n\n// pages/*\nexport const getStaticProps: GetStaticProps = async ({ params }: any): Promise<any>  => {\n    // 略\n    const allTags = getTags();\n    return {\n        props: {\n            // 略\n            allTags\n        },\n    };\n};\n```\n\n## 關於分頁功能\n\n每一頁只顯示10篇文章，所以在`index.tsx`先hard code 只取得文章前10筆，接下來再運用`getStaticPaths`的方式就可以達成分頁功能了！\n\n```typescript jsx\nindex.tsx中的getStaticProps\nexport const getStaticProps: GetStaticProps = async (context: GetStaticPropsContext<ParsedUrlQuery>): Promise<any> => {\n    const posts: Post[] = getAllPosts();\n    const allTags = getTags();\n    return {\n        props: {\n            posts: posts.slice(0, 10),\n            allTags,\n            total: posts.length\n        },\n    };\n};\n\n// [page].tsx\nexport const getStaticProps: GetStaticProps = async (context: GetStaticPropsContext<ParsedUrlQuery>): Promise<any> => {\n    const {\n        page,\n    }: any = context.params;\n\n    const posts: Post[] = getAllPosts();\n    const allTags = getTags();\n\n    const current = parseInt(page ?? '0');\n\n    return {\n        props: {\n            current,\n            posts: posts.slice((current - 1) * 10, current * 10),\n            allTags,\n            total: posts.length,\n        },\n    };\n};\n\nexport const getStaticPaths: GetStaticPaths = async (): Promise<any> => {\n    const pages = [];\n    const posts: Post[] = getAllPosts();\n\n    for (let i = 0; i < posts.length / 10; i++) {\n        pages.push({\n                       params: {\n                           page: `${ i + 1 }`,\n                       },\n                   });\n    }\n\n    return {\n        paths: pages,\n        fallback: false,\n    };\n};\n```\n\n## 參考連結\n\n[Next.js Migrate from Gatsby.js](https://nextjs.org/docs/migrating/from-gatsby)\n"}],"allTags":{"devops":8,"study4":2,"dotnetconf":2,"aws":5,"frontend":2,"next.js":4,"react":5,"i18n":1,"gatsby.js":1,"postgresql":1,"database":2,"dotnet":1,"prevision":6,"iot":2,"platformio":2,"arduino":2,"esp":1,"elk":3,"azure":4,"vulnerability":1,"ssl":2,"vmss":1,"cd":3,"selenium":2,"tdd":1,"jest":1,"layout":1,"ec2":1,"iac":1,"terraform":1,"ci":1,"jenkins":1,"ecs":1,"ansible":1,"redis":2,"protobuf":2,"serialize":2,"deserialize":2,"pub":1,"sub":1,"notify":1}},"__N_SSG":true}