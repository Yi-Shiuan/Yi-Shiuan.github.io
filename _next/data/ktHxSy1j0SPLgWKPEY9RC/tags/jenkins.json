{"pageProps":{"posts":[{"id":1599350400,"fileName":"jenkins-selenium-grid","url":"2020/09/06/jenkins-selenium-grid","title":"透過Jenkins啟動Selenium Grid執行自動化測試","description":"QA測試當然不是只測試RD這次上線的範圍而已，而是把過去上線的功能都要在驗過一遍才能算是經過QA測試的版本，但是隨著時間的積累線上的系統越來越多 有時候QA無法透過手動的方式完成所有驗證，這時候都會導入自動畫測試selenium來協助QA做完系統的驗證，在目前我服務的公司把CD與自動化測試的部分做了整合， 當QAT部署完成後就會驅動QA的自動化驗證，但是當自動化驗證的Job越來越多一台機器已經很難在3-5分鐘內完成自動化測試怎麼辦？","tags":["ci","selenium","jenkins"],"date":"2020-09-06T00:00:00.000Z","published":true,"content":"\n## 寫在前面\n\n一般我們上線流程都含有QA的測試階段，QA的測試與RD的開發有著很大的區別...\n\nQA測試當然不是只測試RD這次上線的範圍而已，而是把過去上線的功能都要在驗過一遍才能算是`經過QA測試`的版本，但是隨著時間的積累線上的系統越來越多\n有時候QA無法透過手動的方式完成所有驗證，這時候都會導入自動畫測試selenium來協助QA做完系統的驗證，在目前我服務的公司把CD與自動化測試的部分做了整合，\n當QAT部署完成後就會驅動QA的自動化驗證，但是當自動化驗證的Job越來越多一台機器已經很難在3-5分鐘內完成自動化測試怎麼辦？\n\n在網路上很多採用Selenium Grid的人，大多都是有一個需求是`多瀏覽器測試`，目前我們只針對chrome做測試但他也能在多台機器上為我們完成許多\n自動化測試的需求，我們則是因為許多小而美的自動化測試需要被完成\n\n> 在做自動化測試的時候，我的建議是每一次只驗證一項功能是否如我們預期的運作，然後把每個工作都拆分成小的Task來完成\n>\n> 好處是可以透過Selenium Grid同時執行驗證減少時間成本，另外也可以避免某一個功能驗證失效，而導致後面的功能無法驗證\n\n## 架構說明\n\nJenkins我是採用Master跟Agent的方式建制的，Selenium 也適用Hub跟Node的方式建置的\n\n![jenkins 與 Selenium Grid架構圖](jenkins-selenium-grid/jenkins-selenium.png)\n\nJenkins與Selenium均採用docker並結合docker compose起動，這邊是我撰寫的`docker-compose.yml`\n\n> 在Selenium Node的部分是採用linux的版本，主要原因是雲端服務的Windows機器價格比較高，所以在部署服務上以linux為主\n\n```yaml\nversion: '3.7'\nservices:\n  master:\n    image: jenkins/jenkins:2.254\n    logging:\n      options:\n        max-size: 100m\n        max-file: \"1\"\n    restart: always\n    user: root\n    networks:\n      - net\n    ports:\n      - \"80:8080\"\n      - \"50000:50000\"\n    volumes:\n      - jenkins:/var/jenkins_home\n    environment:\n      JAVA_OPTS: -Duser.timezone=Asia/Taipei\n      JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF-8\n\n  test:\n    image: docker.boyu66.cc/common/selenium:4.2\n    user: root\n    logging:\n      options:\n        max-size: 100m\n        max-file: \"1\"\n    networks:\n      - net\n    depends_on:\n      - master\n    restart: always\n    volumes:\n      - test:/home/root\n    environment:\n      JAVA_OPTS: -Duser.timezone=Asia/Taipei\n    command: -url http://jenkins.boyu66.cc -workDir /home/root/agent {secretKey} TestAgent\n\n  hub:\n    image: selenium/hub:3.141.59-20200409\n    user: root\n    ports:\n      - \"4444:4444\"\n    logging:\n      options:\n        max-size: 100m\n        max-file: \"1\"\n    networks:\n      - net\n    depends_on:\n      - master\n    restart: always\n\n  chrome:\n    image: selenium/node-chrome:3.141.59-20200409\n    user: root\n    networks:\n      - net\n    volumes:\n      - /dev/shm:/dev/shm\n    depends_on:\n      - hub\n    environment:\n      NODE_MAX_INSTANCES: 10\n      NODE_APPLICATION_NAME: chrome\n      NODE_MAX_SESSION: 10\n      JAVA_OPTS: -Xmx512m\n\n\nnetworks:\n  net:\n    driver: bridge\n\nvolumes:\n  jenkins:\n  test:\n```\n\n## 建立Jenkins test agent的docker image\n\n在test agent 的dockerfile我選用了ubuntu作為base image，時區的部分設定到了台北並安裝openjdk等等的套件\n\n```dockerfile\nFROM ubuntu:18.04\n\nARG VERSION=4.2\nENV TZ='Asia/Taipei' \\\n    HOME=/home/root\nRUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone\n\nRUN apt-get update\nRUN apt-get install -y --no-install-recommends software-properties-common \\\n      openjdk-8-jre curl git \\\n      && apt-get clean\n\nRUN curl --create-dirs -fsSLo /usr/share/jenkins/slave.jar https://repo.jenkins-ci.org/public/org/jenkins-ci/main/remoting/${VERSION}/remoting-${VERSION}.jar \\\n      && chmod 755 /usr/share/jenkins \\\n      && chmod 644 /usr/share/jenkins/slave.jar\n\nWORKDIR /home/root\nUSER root\n\n## Jenkins jnlp slave ##\nCOPY jenkins-slave.sh jenkins-slave.sh\n\n\nENTRYPOINT [\"bash\", \"/home/root/jenkins-slave.sh\"]\n```\n\n最後將Jenkins的Job指定到Test Agent上執行，在Selenium的部分把webdriver的設定改道遠端的位置上就可以享受Selenium Grid了！\n\n## 參考資料\n\n[Selenium Grid 中文文黨](https://wizardforcel.gitbooks.io/selenium-doc/content/official-site/selenium-grid.html)\n"}],"allTags":{"git":1,"vue":1,"nuxt":1,"vite":1,"devops":8,"study4":2,"dotnetconf":2,"aws":5,"frontend":2,"next.js":4,"react":5,"i18n":1,"gatsby.js":1,"postgresql":1,"database":2,"dotnet":1,"prevision":6,"iot":2,"platformio":2,"arduino":2,"esp":1,"elk":3,"azure":4,"vulnerability":1,"ssl":2,"vmss":1,"cd":3,"selenium":2,"tdd":1,"jest":1,"layout":1,"ec2":1,"iac":1,"terraform":1,"ci":1,"jenkins":1,"ecs":1,"ansible":1,"redis":2,"protobuf":2,"serialize":2,"deserialize":2,"pub":1,"sub":1,"notify":1}},"__N_SSG":true}