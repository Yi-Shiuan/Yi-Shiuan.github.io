<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Next.js 的Layout最佳配置 :: Bruno&#x27;s Notes</title><meta name="description" content="新專案即將完成之際，我們開始對各個頁面上的效能與一些過去被我們忽略的問題進行修正， 在這修正的過程中我發現了在每一次頁面切換時都會出現網站的Logo消失又再出現的問題， Logo是一個經常變動的圖片所以在專案中是透過GQL取得Logo的CDN位置後才做渲染的， 再深入排查後才發現原來過去我的觀念不是非常正確所以用這篇來筆記一下正確地處理做法，當作小抄避免未來再犯同樣的錯誤。"/><meta property="og:type" content="website"/><meta property="og:title" content="Next.js 的Layout最佳配置 :: Bruno&#x27;s Notes"/><meta property="og:description" content="新專案即將完成之際，我們開始對各個頁面上的效能與一些過去被我們忽略的問題進行修正， 在這修正的過程中我發現了在每一次頁面切換時都會出現網站的Logo消失又再出現的問題， Logo是一個經常變動的圖片所以在專案中是透過GQL取得Logo的CDN位置後才做渲染的， 再深入排查後才發現原來過去我的觀念不是非常正確所以用這篇來筆記一下正確地處理做法，當作小抄避免未來再犯同樣的錯誤。"/><meta property="og:site_name" content="Bruno&#x27;s Notes"/><meta property="twitter:card" content="summary"/><meta property="twitter:creator" content="Next.js 的Layout最佳配置 :: Bruno&#x27;s Notes"/><meta property="twitter:title" content="Next.js 的Layout最佳配置 :: Bruno&#x27;s Notes"/><meta property="twitter:description" content="新專案即將完成之際，我們開始對各個頁面上的效能與一些過去被我們忽略的問題進行修正， 在這修正的過程中我發現了在每一次頁面切換時都會出現網站的Logo消失又再出現的問題， Logo是一個經常變動的圖片所以在專案中是透過GQL取得Logo的CDN位置後才做渲染的， 再深入排查後才發現原來過去我的觀念不是非常正確所以用這篇來筆記一下正確地處理做法，當作小抄避免未來再犯同樣的錯誤。"/><meta name="next-head-count" content="12"/><link rel="preload" href="/_next/static/css/b6fdcd916ca35284.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b6fdcd916ca35284.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-fbf97c092d1ca569.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6e9e8b3b0d275cb3.js" defer=""></script><script src="/_next/static/chunks/770-0b2a606760df5bd6.js" defer=""></script><script src="/_next/static/chunks/523-2747a577c68987da.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...post%5D-cb4eb702e2926d1c.js" defer=""></script><script src="/_next/static/JIay6FBYgsRWb8DhRuoqF/_buildManifest.js" defer=""></script><script src="/_next/static/JIay6FBYgsRWb8DhRuoqF/_ssgManifest.js" defer=""></script></head><body><div id="__next"><section class="g-layout-boxed g-bgi-v8"><main class="container"><div class="row justify-content-between"><section class="col-lg-3 order-lg-1 g-mb-80-lg g-pt-100--lg"><div class="u-header u-header--side c-navbar-side-left animate__animated animate__fast"><div class="u-header__section-container g-bg-white"><div class="u-header__section u-header__section--light"><nav class="navbar navbar-expand-lg container g-px-17"><div class="w-100"><div class="justify-content-between w-100 d-flex d-lg-block"><a class="navbar-brand g-mb-60--lg" href="/">Bruno&#x27;s Notes</a><button class="navbar-toggler btn btn-md g-line-height-1 g-brd-none g-pa-0 collapsed" type="button"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars fa-lg g-mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"></path></svg></button></div><div class="collapse navbar-collapse align-items-center flex-sm-row w-100 g-mt-20 g-mt-0--lg g-mb-40"><ul class="navbar-nav ml-auto text-uppercase g-font-weight-600 u-sub-menu-v1"><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="/"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="house" class="svg-inline--fa fa-house g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="14.61" height="12.98"><path fill="currentColor" d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"></path></svg>首頁</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="/about"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="user" class="svg-inline--fa fa-user g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14.61" height="12.98"><path fill="currentColor" d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0S96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"></path></svg>關於我</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="https://study4.tw" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="leaf" class="svg-inline--fa fa-leaf g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14.61" height="12.98"><path fill="currentColor" d="M272 96c-78.6 0-145.1 51.5-167.7 122.5c33.6-17 71.5-26.5 111.7-26.5h88c8.8 0 16 7.2 16 16s-7.2 16-16 16H288 216s0 0 0 0c-16.6 0-32.7 1.9-48.3 5.4c-25.9 5.9-49.9 16.4-71.4 30.7c0 0 0 0 0 0C38.3 298.8 0 364.9 0 440v16c0 13.3 10.7 24 24 24s24-10.7 24-24V440c0-48.7 20.7-92.5 53.8-123.2C121.6 392.3 190.3 448 272 448l1 0c132.1-.7 239-130.9 239-291.4c0-42.6-7.5-83.1-21.1-119.6c-2.6-6.9-12.7-6.6-16.2-.1C455.9 72.1 418.7 96 376 96L272 96z"></path></svg>Study4.TW</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="https://www.facebook.com/amour99520" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14.61" height="12.98"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg>Facebook</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="https://github.com/yi-shiuan" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="14.61" height="12.98"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>Github</a><li class="nav-item"><hr class="g-brd-gray-light-v4"/></li><li class="nav-item g-my-5"><h3 class="h5 g-color-black g-font-weight-600 mb-4">系列文章</h3><ul class="u-list-inline mb-0 text-uppercase"></ul></li></ul></div></div></nav></div></div></div></section><section class="col-lg-9 order-lg-5 g-mb-80 g-px-0"><section class="g-mb-80"><img alt="background image" src="/_next/static/media/background.f22cfc26.jpg" width="9750" height="6504" decoding="async" data-nimg="future" class="img-fluid g-height-250" loading="lazy" style="color:transparent;object-fit:cover;background-size:cover;background-position:50% 50%;background-repeat:no-repeat;background-image:url(&quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns=&#x27;http%3A//www.w3.org/2000/svg&#x27; viewBox=&#x27;0 0 8 5&#x27;%3E%3Cfilter id=&#x27;b&#x27; color-interpolation-filters=&#x27;sRGB&#x27;%3E%3CfeGaussianBlur stdDeviation=&#x27;1&#x27;/%3E%3CfeComponentTransfer%3E%3CfeFuncA type=&#x27;discrete&#x27; tableValues=&#x27;1 1&#x27;/%3E%3C/feComponentTransfer%3E%%3C/filter%3E%3Cimage filter=&#x27;url(%23b)&#x27; x=&#x27;0&#x27; y=&#x27;0&#x27; height=&#x27;100%25&#x27; width=&#x27;100%25&#x27; href=&#x27;data:image/jpeg;base64,/9j/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAFAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAdEAABBAIDAAAAAAAAAAAAAAABAAIDBQYREhOR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/xAAaEQACAgMAAAAAAAAAAAAAAAABAgADERMh/9oADAMBAAIRAxEAPwCTxvLnU7esV0E8JHExvcfdoiINNbHJWTsdeAz/2Q==&#x27;/%3E%3C/svg%3E&quot;)"/></section><section class="col-12 g-px-15"><div class="g-mb-30"><p class="d-block g-color-gray-dark-v4 g-font-weight-700 g-font-size-12 text-uppercase mb-2">07 Jan 2021</p><div class="u-heading-v3 g-mb-40"><h1 class="h1 u-heading-v3__title">Next.js 的Layout最佳配置</h1></div><div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">前情提要</h2></div>
<p>新專案即將完成之際，我們開始對各個頁面上的效能與一些過去被我們忽略的問題進行修正，
在這修正的過程中我發現了在每一次頁面切換時都會出現網站的Logo消失又再出現的問題，
Logo是一個經常變動的圖片所以在專案中是透過GQL取得Logo的CDN位置後才做渲染的，
再深入排查後才發現原來過去我的觀念不是非常正確所以用這篇來筆記一下正確地處理做法，當作小抄避免未來再犯同樣的錯誤。</p>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">Next.js Layout最佳配置</h2></div>
<p>在Next.js的Layout最佳配置應該是把Layout的component放在<div></div>中，在轉換頁面時就不會再出現前情提要的相關問題了。</p>
<pre><div></div></pre>
<pre><div></div></pre>
<div class="u-heading-v2-6--bottom g-mb-30 g-mt-30"><h3 class="h3 mb-0">在得到結論前的一些排查點</h3></div>
<p>在一開始我們的<div></div>與<div></div>或其他page都是這樣的設計，在Layout中有<div></div>與<div></div>兩個component以及負責所有頁面上的版面配置，
其中Header這個component中去取得GQL資料，但因為他是屬於React FunctionComponent的範疇，故無法使用getInitialProps這類的function</p>
<pre><div></div></pre>
<pre><div></div></pre>
<ol>
<li>在方案一的我是透過React Memo的方式Cache Layout起來下次使用Layout 這個component時就不會再重新渲染，但結果是仍然每次重新渲染Layout</li>
<li>在_app.tsx中取得相關的Layout配置所需要的圖檔與文字，透過props的方式傳入給Layout中並讓Header在Server side 渲染，
但因為progress image的使用所以Logo仍然會有閃一下的情況</li>
</ol>
<p>然後在官網上看到了這麼一段....
最後我把Layout放置到<div></div>中，就可以如我們預期的一開始出現了progress image的Logo再出現真正的Logo，在每次轉頁時也沒有重新渲染相關的Layout component</p>
<p>我想主要的幾個原因是，_app.tsx的執行時間以及在轉頁渲染的最小單位是整個Next page不是採用差異的方式重新渲染。</p>
<div class="g-brd-blue-left u-shadow-v5 g-bg-white g-brd-around g-brd-gray-light-v4 g-line-height-2 g-pa-40 g-mb-30"><p class="g-mb-0">Next.js uses the App component to initialize pages. You can override it and control the page initialization. Which allows you to do amazing things like:</p><p class="g-mb-0">
<li>Persisting layout between page changes</li>
<li>Keeping state when navigating pages</li>
<li>Custom error handling using componentDidCatch</li>
<li>Inject additional data into pages</li>
<li>Add global CSS</li>
</p><p class="g-mb-0"><a class="u-link-v5 g-color-blue rounded g-py-8 g-color-purple--hover" href="https://nextjs.org/docs/advanced-features/custom-app" target="_blank">Next.js Custom APP</a></p></div>
<div class="u-heading-v2-6--bottom g-mb-30 g-mt-30"><h3 class="h3 mb-0">相關連結</h3></div>
<p><a class="u-link-v5 g-color-blue rounded g-py-8 g-color-purple--hover" href="https://nextjs.org/docs/advanced-features/custom-app" target="_blank">Next.js Custom APP</a></p></div><div class="u-heading-v2-6--bottom g-mb-30 g-mt-30"><h3 class="h3 mb-0">文章標籤</h3></div><ul class="u-list-inline mb-0 text-uppercase g-mb-40--lg g-mb-30--md"></ul><div id="disqus_thread"></div></section></section></div></main></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":1609977600,"fileName":"best-practice-layout-in-nextjs","url":"2021/01/07/best-practice-layout-in-nextjs","title":"Next.js 的Layout最佳配置","description":"新專案即將完成之際，我們開始對各個頁面上的效能與一些過去被我們忽略的問題進行修正， 在這修正的過程中我發現了在每一次頁面切換時都會出現網站的Logo消失又再出現的問題， Logo是一個經常變動的圖片所以在專案中是透過GQL取得Logo的CDN位置後才做渲染的， 再深入排查後才發現原來過去我的觀念不是非常正確所以用這篇來筆記一下正確地處理做法，當作小抄避免未來再犯同樣的錯誤。","date":"2021-01-07T00:00:00.000Z","tags":{},"published":true,"content":"\n## 前情提要\n\n新專案即將完成之際，我們開始對各個頁面上的效能與一些過去被我們忽略的問題進行修正，\n在這修正的過程中我發現了在每一次頁面切換時都會出現網站的Logo消失又再出現的問題，\nLogo是一個經常變動的圖片所以在專案中是透過GQL取得Logo的CDN位置後才做渲染的，\n再深入排查後才發現原來過去我的觀念不是非常正確所以用這篇來筆記一下正確地處理做法，當作小抄避免未來再犯同樣的錯誤。\n\n## Next.js Layout最佳配置\n\n在Next.js的Layout最佳配置應該是把Layout的component放在`_app.tsx`中，在轉換頁面時就不會再出現前情提要的相關問題了。\n\n```typescript jsx\nfunction App({Component, pageProps }: AppProps): any {\n\tconst apolloClient: any = useApollo(pageProps.initialApolloState);\n\n\treturn \u003cApolloProvider client={apolloClient}\u003e\n\t\t    \u003cLayout\u003e\n\t\t\t    \u003cComponent {...pageProps} /\u003e\n\t\t\t\u003c/Layout\u003e\n\t\t\u003c/ApolloProvider\u003e\n}\n```\n\n```typescript jsx\nconst Index: NextPage\u003cany\u003e = (props: any): any =\u003e {\n\treturn \u003c\u003e\n            {/*index content*/}\n\t\t\u003c/\u003e\n};\n```\n\n\n### 在得到結論前的一些排查點\n\n在一開始我們的`_app.tsx`與`index.tsx`或其他page都是這樣的設計，在Layout中有`Header`與`Footer`兩個component以及負責所有頁面上的版面配置，\n其中Header這個component中去取得GQL資料，但因為他是屬於React FunctionComponent的範疇，故無法使用getInitialProps這類的function\n\n```typescript jsx\nfunction App({Component, pageProps }: AppProps): any {\n\tconst apolloClient: any = useApollo(pageProps.initialApolloState);\n\n\treturn \u003cApolloProvider client={apolloClient}\u003e\n\t\t\t\u003cComponent {...pageProps} /\u003e\n\t\t\u003c/ApolloProvider\u003e\n}\n```\n\n```typescript jsx\nconst Index: NextPage\u003cany\u003e = (props: any): any =\u003e {\n\treturn \u003cLayout\u003e\n            {/*index content*/}\n\t\t\u003c/Layout\u003e\n};\n```\n\n1. 在方案一的我是透過React Memo的方式Cache Layout起來下次使用Layout 這個component時就不會再重新渲染，但結果是仍然每次重新渲染Layout\n1. 在_app.tsx中取得相關的Layout配置所需要的圖檔與文字，透過props的方式傳入給Layout中並讓Header在Server side 渲染，\n但因為progress image的使用所以Logo仍然會有閃一下的情況\n\n然後在官網上看到了這麼一段....\n最後我把Layout放置到`_app.tsx`中，就可以如我們預期的一開始出現了progress image的Logo再出現真正的Logo，在每次轉頁時也沒有重新渲染相關的Layout component\n\n我想主要的幾個原因是，_app.tsx的執行時間以及在轉頁渲染的最小單位是整個Next page不是採用差異的方式重新渲染。\n\n\u003e Next.js uses the App component to initialize pages. You can override it and control the page initialization. Which allows you to do amazing things like:\n\u003e\n\u003e - Persisting layout between page changes\n\u003e - Keeping state when navigating pages\n\u003e - Custom error handling using componentDidCatch\n\u003e - Inject additional data into pages\n\u003e - Add global CSS\n\u003e\n\u003e [Next.js Custom APP](https://nextjs.org/docs/advanced-features/custom-app)\n\n### 相關連結\n\n[Next.js Custom APP](https://nextjs.org/docs/advanced-features/custom-app)\n"},"__N_SSG":true},"page":"/posts/[...post]","query":{"post":["2021","01","07","best-practice-layout-in-nextjs"]},"buildId":"JIay6FBYgsRWb8DhRuoqF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>