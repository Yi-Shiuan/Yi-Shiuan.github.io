<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Terraform 做 AWS IaC :: Bruno&#x27;s Notes</title><meta name="description" content="一直在公司使用ansible來做Cloud configuration但是ansible在cloud configuration上說真的略顯不足， 在之前的文章中我們很常使用`aws cli`來做相對應的處理。使用aws cli時要有更好的可讀性與維護性，通常都以JSON的格式輸入 因此在ansible中的playbook上就會有多餘的一些步驟去設定餵給aws cli的JSON。"/><meta property="og:type" content="website"/><meta property="og:title" content="Terraform 做 AWS IaC :: Bruno&#x27;s Notes"/><meta property="og:description" content="一直在公司使用ansible來做Cloud configuration但是ansible在cloud configuration上說真的略顯不足， 在之前的文章中我們很常使用`aws cli`來做相對應的處理。使用aws cli時要有更好的可讀性與維護性，通常都以JSON的格式輸入 因此在ansible中的playbook上就會有多餘的一些步驟去設定餵給aws cli的JSON。"/><meta property="og:site_name" content="Bruno&#x27;s Notes"/><meta property="twitter:card" content="summary"/><meta property="twitter:creator" content="Terraform 做 AWS IaC :: Bruno&#x27;s Notes"/><meta property="twitter:title" content="Terraform 做 AWS IaC :: Bruno&#x27;s Notes"/><meta property="twitter:description" content="一直在公司使用ansible來做Cloud configuration但是ansible在cloud configuration上說真的略顯不足， 在之前的文章中我們很常使用`aws cli`來做相對應的處理。使用aws cli時要有更好的可讀性與維護性，通常都以JSON的格式輸入 因此在ansible中的playbook上就會有多餘的一些步驟去設定餵給aws cli的JSON。"/><meta name="next-head-count" content="12"/><link rel="preload" href="/_next/static/css/b6fdcd916ca35284.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b6fdcd916ca35284.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-fbf97c092d1ca569.js" defer=""></script><script src="/_next/static/chunks/pages/_app-652f16ac644b9842.js" defer=""></script><script src="/_next/static/chunks/770-0b2a606760df5bd6.js" defer=""></script><script src="/_next/static/chunks/523-2747a577c68987da.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...post%5D-3ca148f93b3fcf74.js" defer=""></script><script src="/_next/static/eLlB-DKNmgsWZefxJTpN8/_buildManifest.js" defer=""></script><script src="/_next/static/eLlB-DKNmgsWZefxJTpN8/_ssgManifest.js" defer=""></script></head><body><div id="__next"><section class="g-layout-boxed g-bgi-v8"><main class="container"><div class="row justify-content-between"><section class="col-lg-3 order-lg-1 g-mb-80-lg g-pt-100--lg"><div class="u-header u-header--side c-navbar-side-left animate__animated animate__fast"><div class="u-header__section-container g-bg-white"><div class="u-header__section u-header__section--light"><nav class="navbar navbar-expand-lg container g-px-17"><div class="w-100"><div class="justify-content-between w-100 d-flex d-lg-block"><a class="navbar-brand g-mb-60--lg" href="/">Bruno&#x27;s Notes</a><button class="navbar-toggler btn btn-md g-line-height-1 g-brd-none g-pa-0 collapsed" type="button"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="bars" class="svg-inline--fa fa-bars fa-lg g-mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"></path></svg></button></div><div class="collapse navbar-collapse align-items-center flex-sm-row w-100 g-mt-20 g-mt-0--lg g-mb-40"><ul class="navbar-nav ml-auto text-uppercase g-font-weight-600 u-sub-menu-v1"><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="/"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="house" class="svg-inline--fa fa-house g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="14.61" height="12.98"><path fill="currentColor" d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"></path></svg>首頁</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="/about"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="user" class="svg-inline--fa fa-user g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="14.61" height="12.98"><path fill="currentColor" d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0S96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"></path></svg>關於我</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="https://study4.tw" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="leaf" class="svg-inline--fa fa-leaf g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14.61" height="12.98"><path fill="currentColor" d="M272 96c-78.6 0-145.1 51.5-167.7 122.5c33.6-17 71.5-26.5 111.7-26.5h88c8.8 0 16 7.2 16 16s-7.2 16-16 16H288 216s0 0 0 0c-16.6 0-32.7 1.9-48.3 5.4c-25.9 5.9-49.9 16.4-71.4 30.7c0 0 0 0 0 0C38.3 298.8 0 364.9 0 440v16c0 13.3 10.7 24 24 24s24-10.7 24-24V440c0-48.7 20.7-92.5 53.8-123.2C121.6 392.3 190.3 448 272 448l1 0c132.1-.7 239-130.9 239-291.4c0-42.6-7.5-83.1-21.1-119.6c-2.6-6.9-12.7-6.6-16.2-.1C455.9 72.1 418.7 96 376 96L272 96z"></path></svg>Study4.TW</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="https://www.facebook.com/amour99520" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14.61" height="12.98"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg>Facebook</a><a class="d-block u-link-v5 g-color-gray-dark-v4 rounded g-py-8 g-color-purple--hover" href="https://github.com/yi-shiuan" target="_blank"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github g-mr-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="14.61" height="12.98"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>Github</a><li class="nav-item"><hr class="g-brd-gray-light-v4"/></li><li class="nav-item g-my-5"><h3 class="h5 g-color-black g-font-weight-600 mb-4">系列文章</h3><ul class="u-list-inline mb-0 text-uppercase"></ul></li></ul></div></div></nav></div></div></div></section><section class="col-lg-9 order-lg-5 g-mb-80 g-px-0"><section class="g-mb-80"><img alt="background image" src="/_next/static/media/background.f22cfc26.jpg" width="9750" height="6504" decoding="async" data-nimg="future" class="img-fluid g-height-250" loading="lazy" style="color:transparent;object-fit:cover;background-size:cover;background-position:50% 50%;background-repeat:no-repeat;background-image:url(&quot;data:image/svg+xml;charset=utf-8,%3Csvg xmlns=&#x27;http%3A//www.w3.org/2000/svg&#x27; viewBox=&#x27;0 0 8 5&#x27;%3E%3Cfilter id=&#x27;b&#x27; color-interpolation-filters=&#x27;sRGB&#x27;%3E%3CfeGaussianBlur stdDeviation=&#x27;1&#x27;/%3E%3CfeComponentTransfer%3E%3CfeFuncA type=&#x27;discrete&#x27; tableValues=&#x27;1 1&#x27;/%3E%3C/feComponentTransfer%3E%%3C/filter%3E%3Cimage filter=&#x27;url(%23b)&#x27; x=&#x27;0&#x27; y=&#x27;0&#x27; height=&#x27;100%25&#x27; width=&#x27;100%25&#x27; href=&#x27;data:image/jpeg;base64,/9j/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAFAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAb/xAAdEAABBAIDAAAAAAAAAAAAAAABAAIDBQYREhOR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/xAAaEQACAgMAAAAAAAAAAAAAAAABAgADERMh/9oADAMBAAIRAxEAPwCTxvLnU7esV0E8JHExvcfdoiINNbHJWTsdeAz/2Q==&#x27;/%3E%3C/svg%3E&quot;)"/></section><section class="col-12 g-px-15"><div class="g-mb-30"><p class="d-block g-color-gray-dark-v4 g-font-weight-700 g-font-size-12 text-uppercase mb-2">19 Sep 2020</p><div class="u-heading-v3 g-mb-40"><h1 class="h1 u-heading-v3__title">Terraform 做 AWS IaC</h1></div><div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">寫在前面</h2></div>
<p>一直在公司使用ansible來做Cloud configuration但是ansible在cloud configuration上說真的略顯不足，
在之前的文章中我們很常使用<div></div>來做相對應的處理。使用aws cli時要有更好的可讀性與維護性，通常都以JSON的格式輸入
因此在ansible中的playbook上就會有多餘的一些步驟去設定餵給aws cli的JSON。</p>
<p>這一篇就用terraform來建立一個aws AutoScaling Group吧！</p>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">安裝Terraform</h2></div>
<p>terraform的安裝其實非常簡單，在下方的參考連結中有其他的安裝方式，我這邊主要會使用mac的安裝方式</p>
<p>在mac安裝terraform我是透過<a class="u-link-v5 g-color-blue rounded g-py-8 g-color-purple--hover" href="https://brew.sh/index_zh-tw" target="_blank">Homebrew</a>來安裝terraform</p>
<pre><div></div></pre>
<p>安裝完成後做一個簡單的驗證，開啟你習慣的terminal執行以下的command就可以知道我們是不是有安裝成功了，
如果安裝成功就會出現跟下圖一樣的資訊出來，就可以進行下一步了！</p>
<pre><div></div></pre>
<p><div class="text-center g-mb-30 g-pa-10-30"><div><img class="img-fluid u-shadow-v2 g-rounded-3 g-mb-10" src="./terraform-install.png" alt="安裝terrafrom的驗證"/></div><em class="g-color-gray-light-v1">安裝terrafrom的驗證</em></div></p>
<div class="g-brd-blue-left u-shadow-v5 g-bg-white g-brd-around g-brd-gray-light-v4 g-line-height-2 g-pa-40 g-mb-30"><p class="g-mb-0">如果透過Homebrew安裝不成功，可以試試看brew upgrade，更新一下homebrew</p></div>
<p>因terraform最後會產生aws cli的command，在安裝完畢後需要安裝aws cli並且設定aws的一些infomation
並且設定aws的access key跟secert key的部分</p>
<pre><div></div></pre>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">初始化terraform</h2></div>
<p>這一篇的目標是要用terrafrom建立aws 的auto scaling group，在達成目標前terraform前需要先做初始化</p>
<p>初始化其實非常容易，先在你的terraform的資料夾下先建立一個<div></div>的黨案，定義provider</p>
<p>執行<div></div>後會有下方的資訊出現並且在資料夾中會有一個<div></div>的資料夾</p>
<pre><div></div></pre>
<pre><div></div></pre>
<p><div class="text-center g-mb-30 g-pa-10-30"><div><img class="img-fluid u-shadow-v2 g-rounded-3 g-mb-10" src="./terraform-init.png" alt="terraform init訊息"/></div><em class="g-color-gray-light-v1">terraform init訊息</em></div></p>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">透過terrafrom 建立 AWS AutoScaling Group</h2></div>
<p>接下來要建立一個<div></div>或是使用前一步的<div></div>，撰寫resource的設定有關於aws 的resource定義資料
可以參考下方的參考連結中的<strong>terraform aws provider</strong></p>
<pre><div></div></pre>
<div class="u-heading-v2-6--bottom g-mb-30 g-mt-30"><h3 class="h3 mb-0">Apply</h3></div>
<p>在terraform要真的去建立資源的command 是<div></div>，在真正到aws上建立資源前會有一個預覽資料等待你的確認才會真正的建立資源</p>
<pre><div></div></pre>
<div class="g-brd-blue-left u-shadow-v5 g-bg-white g-brd-around g-brd-gray-light-v4 g-line-height-2 g-pa-40 g-mb-30"><p class="g-mb-0">如果在CI的魔是可以透過auto-approve，來略過確認輸入的情況</p></div>
<div class="u-heading-v2-6--bottom g-mb-30 g-mt-30"><h3 class="h3 mb-0">Plan</h3></div>
<p>如果你想先看看資源變更的情況或是dry run時可以使用<div></div>來先做預覽
預覽後可以直接變更資源如下方圖片中的的文字 <strong>terraform apply &quot;plan&quot;</strong></p>
<pre><div></div></pre>
<p><div class="text-center g-mb-30 g-pa-10-30"><div><img class="img-fluid u-shadow-v2 g-rounded-3 g-mb-10" src="./terraform-plan.png" alt="terraform plan"/></div><em class="g-color-gray-light-v1">terraform plan</em></div></p>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">Oops！我的Resource被修改了！</h2></div>
<p>在完成第一個resource的建立後，要建立第二個autoscaling時我用了這樣的main.tf，但是出現了一些狀況...</p>
<pre><div></div></pre>
<p>這時候發現剛才建立的resource被刪除並重新建立了，
這個原因是因為你當下的資料夾出現了terraform.tfstate的檔案，將你剛才的資源資訊存放在此以便後續的資源管理
但...我該如何產生其他新的auto scaling group呢？</p>
<p>答案是使用terraform workspace的方式去建立一個新的workspace，讓每一個資源都是互相獨立的</p>
<pre><div></div></pre>
<p><div class="text-center g-mb-30 g-pa-10-30"><div><img class="img-fluid u-shadow-v2 g-rounded-3 g-mb-10" src="./terraform-workspace.png" alt="terraform workspace"/></div><em class="g-color-gray-light-v1">terraform workspace</em></div></p>
<p>接下來再重新執行一次plan指令就會發現預覽的資訊上變成了新建而不是刪除重建的狀態</p>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">Terraform的文件管理分享</h2></div>
<p>隨著管理的資源的建立開始會發現有許多重複的main.tf，然後要修改某個資訊要修改多個main.tf，那要如何去共用這些main.tf呢？</p>
<p>在結構分享前我先介紹幾個terraform重要的檔案，詳細的設定請看參考連結中的<div></div>官網介紹</p>
<ul>
<li>
<p>main.tf</p>
<p>main.tf是要設定AWS或是其他雲端的資源設定</p>
</li>
<li>
<p>variables.tf</p>
<p>variables.tf 則是預先定義變數，在main.tf中所用的變數資料都要在此先做定義</p>
</li>
<li>
<p>xxxxx.tfvars</p>
<p><div></div> 則是預先輸入好的參數設定，後續就不需要在cli中輸入大量的資訊</p>
</li>
</ul>
<p><div class="text-center g-mb-30 g-pa-10-30"><div><img class="img-fluid u-shadow-v2 g-rounded-3 g-mb-10" src="./terraform-folder.png" alt="terraform 的資料夾結構"/></div><em class="g-color-gray-light-v1">terraform 的資料夾結構</em></div></p>
<p>在資料夾結構中，我依照aws的服務去建立相關的資料夾（如：alb, auto scaling group等等）去建立資料夾
在每個資料夾下都會有main.tf, variables.tf, xxxxx.tfvars的檔案，在workspace的命名上會採用與tfvars的檔名相同
並且會把workspace的名稱打在aws 服務的tag中方便未來做管理。</p>
<div class="g-brd-blue-left u-shadow-v5 g-bg-white g-brd-around g-brd-gray-light-v4 g-line-height-2 g-pa-40 g-mb-30"><p class="g-mb-0">Tips: 在variables.tf中的變數宣告建議都放上預設值，未來要刪除資源時會更加方便！</p></div>
<div class="u-heading-v2-5--bottom g-mt-40 g-mb-40"><h2 class="h2">參考連結</h2></div>
<p><a class="u-link-v5 g-color-blue rounded g-py-8 g-color-purple--hover" href="https://learn.hashicorp.com/tutorials/terraform/install-cli#install-terraform" target="_blank">Install Terraform</a></p>
<p><a class="u-link-v5 g-color-blue rounded g-py-8 g-color-purple--hover" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" target="_blank">terraform aws provider</a></p>
<p><a class="u-link-v5 g-color-blue rounded g-py-8 g-color-purple--hover" href="https://www.terraform.io/docs/configuration/index.html" target="_blank">terraform configuration language</a></p></div><div class="u-heading-v2-6--bottom g-mb-30 g-mt-30"><h3 class="h3 mb-0">文章標籤</h3></div><ul class="u-list-inline mb-0 text-uppercase g-mb-40--lg g-mb-30--md"><li class="list-inline-item g-mb-10"><a class="u-tags-v1 g-color-gray-dark-v4 g-color-white--hover g-bg-gray-light-v5 g-bg-purple--hover g-font-size-12 g-rounded-50 g-py-4 g-px-15" href="/tags/aws"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag g-mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="8"><path fill="currentColor" d="M0 80V229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7H48C21.5 32 0 53.5 0 80zm112 96c-17.7 0-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32s-14.3 32-32 32z"></path></svg>aws</a></li><li class="list-inline-item g-mb-10"><a class="u-tags-v1 g-color-gray-dark-v4 g-color-white--hover g-bg-gray-light-v5 g-bg-purple--hover g-font-size-12 g-rounded-50 g-py-4 g-px-15" href="/tags/iac"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag g-mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="8"><path fill="currentColor" d="M0 80V229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7H48C21.5 32 0 53.5 0 80zm112 96c-17.7 0-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32s-14.3 32-32 32z"></path></svg>iac</a></li><li class="list-inline-item g-mb-10"><a class="u-tags-v1 g-color-gray-dark-v4 g-color-white--hover g-bg-gray-light-v5 g-bg-purple--hover g-font-size-12 g-rounded-50 g-py-4 g-px-15" href="/tags/terraform"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="tag" class="svg-inline--fa fa-tag g-mr-2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="8"><path fill="currentColor" d="M0 80V229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7H48C21.5 32 0 53.5 0 80zm112 96c-17.7 0-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32s-14.3 32-32 32z"></path></svg>terraform</a></li></ul><div id="disqus_thread"></div></section></section></div></main></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":1600473600,"fileName":"terraform-aws-infrastructure-as-code","url":"2020/09/19/terraform-aws-infrastructure-as-code","title":"Terraform 做 AWS IaC","description":"一直在公司使用ansible來做Cloud configuration但是ansible在cloud configuration上說真的略顯不足， 在之前的文章中我們很常使用`aws cli`來做相對應的處理。使用aws cli時要有更好的可讀性與維護性，通常都以JSON的格式輸入 因此在ansible中的playbook上就會有多餘的一些步驟去設定餵給aws cli的JSON。","tags":["aws","iac","terraform"],"date":"2020-09-19T00:00:00.000Z","published":true,"content":"\n## 寫在前面\n\n一直在公司使用ansible來做Cloud configuration但是ansible在cloud configuration上說真的略顯不足，\n在之前的文章中我們很常使用`aws cli`來做相對應的處理。使用aws cli時要有更好的可讀性與維護性，通常都以JSON的格式輸入\n因此在ansible中的playbook上就會有多餘的一些步驟去設定餵給aws cli的JSON。\n\n這一篇就用terraform來建立一個aws AutoScaling Group吧！\n\n## 安裝Terraform\n\nterraform的安裝其實非常簡單，在下方的參考連結中有其他的安裝方式，我這邊主要會使用mac的安裝方式\n\n在mac安裝terraform我是透過[Homebrew](https://brew.sh/index_zh-tw)來安裝terraform\n\n```shell script\n# For mac\nbrew install hashicorp/tap/terraform\n```\n\n安裝完成後做一個簡單的驗證，開啟你習慣的terminal執行以下的command就可以知道我們是不是有安裝成功了，\n如果安裝成功就會出現跟下圖一樣的資訊出來，就可以進行下一步了！\n\n\n```shell script\nterraform -help\n```\n\n![安裝terrafrom的驗證](./terraform-install.png)\n\n\u003e 如果透過Homebrew安裝不成功，可以試試看brew upgrade，更新一下homebrew\n\n因terraform最後會產生aws cli的command，在安裝完畢後需要安裝aws cli並且設定aws的一些infomation\n並且設定aws的access key跟secert key的部分\n\n```shell script\n# install aws cli\nbrew install awscli\n\n# configure aws setting\naws configure\n```\n\n## 初始化terraform\n\n這一篇的目標是要用terrafrom建立aws 的auto scaling group，\b在達成目標前terraform前需要先做初始化\n\n初始化其實非常容易，先在你的terraform的資料夾下先建立一個`main.tf`的黨案，定義provider\n\n執行`init`後會有下方的資訊出現並且在資料夾中會有一個`.terraform`的資料夾\n\n```hlc\nterraform {\n  required_version = \"\u003e= 0.13\"\n}\n\nprovider \"aws\"\n  region = \"ap-northeast-1\"\n}\n```\n\n\n```shell script\nterraform init\n```\n\n![terraform init訊息](./terraform-init.png)\n\n## 透過terrafrom 建立 AWS AutoScaling Group\n\n接下來要建立一個`main.tf`或是使用前一步的`main.tf`，撰寫resource的設定有關於aws 的resource定義資料\n可以參考下方的參考連結中的**terraform aws provider**\n\n```hlc\nresource \"aws_autoscaling_group\" \"asg\" {\n  name                      = \"test-autoscaling-group\"\n  max_size                  = 1\n  min_size                  = 1\n  health_check_grace_period = 300\n  health_check_type         = \"ELB\"\n  desired_capacity          = 1\n  force_delete              = true\n  availability_zones        = [\"ap-northeast-1a\", \"ap-northeast-1d\"]\n  launch_template {\n    id      = \"lt-xxxxxxxx\" # 使用前需要把Id置換掉\n    version = \"$Latest\"\n  }\n}\n```\n\n### Apply\n在terraform要真的去建立資源的command 是`apply`，在真正到aws上建立資源前會有一個預覽資料等待你的確認才會真正的建立資源\n\n```shell script\nterraform apply\n```\n\n\u003e 如果在CI的魔是可以透過auto-approve，來略過確認輸入的情況\n\n### Plan\n\n如果你想先看看資源變更的情況或是dry run時可以使用`plan`來先做預覽\n預覽後可以直接變更資源如下方圖片中的的文字 **terraform apply \"plan\"**\n\n```shell script\nterraform plan -out plan\n\n#確認後可以執行\nterraform apply \"plan\"\n```\n\n![terraform plan](./terraform-plan.png)\n\n## Oops！我的Resource被修改了！\n\n在完成第一個resource的建立後，要建立第二個autoscaling時我用了這樣的main.tf，但是出現了一些狀況...\n\n```hlc\nresource \"aws_autoscaling_group\" \"asg\" {\n  name                      = \"test-autoscaling-group2\"\n  max_size                  = 1\n  min_size                  = 1\n  health_check_grace_period = 300\n  health_check_type         = \"ELB\"\n  desired_capacity          = 1\n  force_delete              = true\n  availability_zones        = [\"ap-northeast-1a\", \"ap-northeast-1d\"]\n  launch_template {\n    id      = \"lt-xxxxxxxx\" # 使用前需要把Id置換掉\n    version = \"$Latest\"\n  }\n}\n```\n\n這時候發現剛才建立的resource被刪除並重新建立了，\n這個原因是因為你當下的資料夾出現了terraform.tfstate的檔案，將你剛才的資源資訊存放在此以便後續的資源管理\n但...我該如何產生其他新的auto scaling group呢？\n\n答案是使用terraform workspace的方式去建立一個新的workspace，讓每一個資源都是互相獨立的\n\n```shell script\nterraform workspace new auto-scaling-group-2\n```\n\n![terraform workspace](./terraform-workspace.png)\n\n接下來再重新執行一次plan指令就會發現預覽的資訊上變成了新建而不是刪除重建的狀態\n\n## Terraform的文件管理分享\n\n隨著管理的資源的建立開始會發現有許多重複的main.tf，然後要修改某個資訊要修改多個main.tf，那要如何去共用這些main.tf呢？\n\n在結構分享前我先介紹幾個terraform重要的檔案，詳細的設定請看參考連結中的`terraform configuration language`官網介紹\n\n- main.tf\n\n    main.tf是要設定AWS或是其他雲端的資源設定\n\n- variables.tf\n\n    variables.tf 則是預先定義變數，在main.tf中所用的變數資料都要在此先做定義\n\n- xxxxx.tfvars\n\n    `.tfvars` 則是預先輸入好的參數設定，後續就不需要在cli中輸入大量的資訊\n\n\n![terraform 的資料夾結構](./terraform-folder.png)\n\n在資料夾結構中，我依照aws的服務去建立相關的資料夾（如：alb, auto scaling group等等）去建立資料夾\n在每個資料夾下都會有main.tf, variables.tf, xxxxx.tfvars的檔案，在workspace的命名上會採用與tfvars的檔名相同\n並且會把workspace的名稱打在aws 服務的tag中方便未來做管理。\n\n\u003e Tips: 在variables.tf中的變數宣告建議都放上預設值，未來要刪除資源時會更加方便！\n\n\n## 參考連結\n\n[Install Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli#install-terraform)\n\n[terraform aws provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)\n\n[terraform configuration language](https://www.terraform.io/docs/configuration/index.html)\n"},"__N_SSG":true},"page":"/posts/[...post]","query":{"post":["2020","09","19","terraform-aws-infrastructure-as-code"]},"buildId":"eLlB-DKNmgsWZefxJTpN8","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>